<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='简介 与 使用场景 简介 SocketLog 是一款高效的、探针式的服务器端程序调试和分析工具。 将“探针”引入到目标项目后，SocketLog 会通过在服务端启动的一个'>
<title>SocketLog</title>

<link rel='canonical' href='http://www.shentongtong.cn/SocketLog/'>

<link rel="stylesheet" href="/scss/style.min.83fdf04f357d6c514ee15e600463b045549e8b40c428f14454adecaa742b352f.css"><meta property='og:title' content='SocketLog'>
<meta property='og:description' content='简介 与 使用场景 简介 SocketLog 是一款高效的、探针式的服务器端程序调试和分析工具。 将“探针”引入到目标项目后，SocketLog 会通过在服务端启动的一个'>
<meta property='og:url' content='http://www.shentongtong.cn/SocketLog/'>
<meta property='og:site_name' content=''>
<meta property='og:type' content='article'><meta property='article:section' content='Technology' /><meta property='article:published_time' content='2022-11-03T20:00:00&#43;08:00'/><meta property='article:modified_time' content='2022-11-03T20:00:00&#43;08:00'/><meta property='og:image' content='http://www.shentongtong.cn/SocketLog/img/SocketLog_Sample.png' />
<meta name="twitter:title" content="SocketLog">
<meta name="twitter:description" content="简介 与 使用场景 简介 SocketLog 是一款高效的、探针式的服务器端程序调试和分析工具。 将“探针”引入到目标项目后，SocketLog 会通过在服务端启动的一个"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://www.shentongtong.cn/SocketLog/img/SocketLog_Sample.png' />
    <link rel="shortcut icon" href="favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky compact">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu3dc13b097e2f7867805642a43cfa2f61_11429_300x0_resize_mitchellnetravali_3.png" width="300"
                            height="362" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        

        <div class="site-meta">
            <h1 class="site-name"><a href="/"></a></h1>
            <h2 class="site-description">申通通</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                <span>分类</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/contact/' >
                
                
                
                <span>联系</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories/technology/' >
                
                
                
                <span>技术</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>暗色模式</span>
                </li>
            
        </div>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/SocketLog/">
                <img src="/SocketLog/img/SocketLog_Sample_huef4a9976d247fdf105029710fc1a7f47_105911_800x0_resize_mitchellnetravali_3.png"
                        srcset="/SocketLog/img/SocketLog_Sample_huef4a9976d247fdf105029710fc1a7f47_105911_800x0_resize_mitchellnetravali_3.png 800w, /SocketLog/img/SocketLog_Sample_huef4a9976d247fdf105029710fc1a7f47_105911_1600x0_resize_mitchellnetravali_3.png 1600w"
                        width="800" 
                        height="311" 
                        loading="lazy"
                        alt="Featured image of post SocketLog" />

                
            </a>
        </div>
    

    <style>
    .back {
        width:110.4px;
        height:34.11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family:var(--base-font-family);
        font-size:1.6rem;
        box-sizing:border-box;
        float: right;
        color: black;
        background-color: rgba(0,102, 153, 0.5);
        margin-left: auto;
        gap: 10px;
        border-radius: 5px;
    }
    .back:hover {
        background-color: rgba(0,102, 153, 0.5);
    }

</style>

<div class="article-details">
    
    <header>
        <span class="article-category" style="float: left;">
            
            <a href="/categories/technology/" >
                Technology
            </a>
            
        </span>

        
        
        
        
            <span><a class="back" href="javascript:history.back()">返回</a></span>
        
    </header>
    


    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/SocketLog/">SocketLog</a>
        </h2>

        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 03, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 10 分钟
                </time>
            </div>
        
    </footer>
    

    

    
    

    
    
    <nav id="TableOfContents">
  <ul>
    <li><a href="#简介-与-使用场景">简介 与 使用场景</a>
      <ul>
        <li><a href="#简介">简介</a></li>
        <li><a href="#场景">场景</a></li>
      </ul>
    </li>
    <li><a href="#文件说明">文件说明</a>
      <ul>
        <li><a href="#探针文件-slogfunctionphp">探针文件 slog.function.php</a></li>
        <li><a href="#收集调试日志的函数类文件">收集调试日志的函数类文件</a></li>
      </ul>
    </li>
    <li><a href="#安装与使用">安装与使用</a>
      <ul>
        <li><a href="#安装">安装</a></li>
        <li><a href="#引入探针文件">引入探针文件</a></li>
        <li><a href="#端口占用说明">端口占用说明</a></li>
        <li><a href="#设置-client_idclient_id-可以是你任意指定的字符串">设置 client_id【client_id 可以是你任意指定的字符串】</a></li>
      </ul>
    </li>
    <li><a href="#示例">示例</a>
      <ul>
        <li><a href="#日志类型">日志类型</a></li>
        <li><a href="#其他配置项">其他配置项</a></li>
      </ul>
    </li>
    <li><a href="#sql-调试">Sql 调试</a>
      <ul>
        <li><a href="#端口-与-执行流程">端口 与 执行流程</a></li>
      </ul>
    </li>
  </ul>
</nav>
    

</div>

</header>

    <section class="article-content">
    
    
    <h2 id="简介-与-使用场景">简介 与 使用场景</h2>
<h3 id="简介">简介</h3>
<p>SocketLog 是一款高效的、探针式的服务器端程序调试和分析工具。</p>
<p>将“探针”引入到目标项目后，SocketLog 会通过在服务端启动的一个 WebSocket 服务，将程序执行过程中收集到的调试信息推送到客户端。 客户端会通过一个 浏览器插件（支持 Chrome 与 Firefox） 将调试信息打印到浏览器的 Console 中，这些信息包括程序的运行时间、吞吐率、内存消耗；PHP 的 Error、warning、notice 信息；程序执行的 SQL 语句以及对 SQL 语句的 explain 等等。</p>
<p>SocketLog 使用 PHP 和 NodeJs 开发，适合用于调试 Ajax 方式发起的请求和 API 项目。</p>
<h3 id="场景">场景</h3>
<ul>
<li>微信API开发调试</li>
</ul>
<p>SocketLog 是一款高效的、探针式的服务器端程序调试和分析工具。</p>
<p>将“探针”引入到目标项目后，SocketLog 会通过在服务端启动的一个 WebSocket 服务，将程序执行过程中收集到的调试信息推送到客户端。 客户端会通过一个 浏览器插件（支持 Chrome 与 Firefox） 将调试信息打印到浏览器的 Console 中，这些信息包括程序的运行时间、吞吐率、内存消耗；PHP 的 Error、warning、notice 信息；程序执行的 SQL 语句以及对 SQL 语句的 explain 等等。</p>
<p>SocketLog 使用 PHP 和 NodeJs 开发，适合用于调试 Ajax 方式发起的请求和 API 项目。</p>
<ul>
<li>API Bug 调试</li>
</ul>
<p>正在运行的 API 有 bug，不能使用 var_dump() 进行调试，因为会影响 client 的调用。 将日志写到文件，查看也不方便，特别是带调用栈或大数据结构的文件日志，查看起来十分困难。</p>
<ul>
<li>其他场景</li>
</ul>
<p>分析开源程序、分析 SQL 性能、结合 PHP Taint 分析程序漏洞。</p>
<h2 id="文件说明">文件说明</h2>
<h3 id="探针文件-slogfunctionphp">探针文件 slog.function.php</h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">require</span> <span style="color:#5af78e">&#39;slog.class.php&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">use</span> think\slog\Slog;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">slog</span>(<span style="color:#ff5c57">$log</span>, <span style="color:#ff5c57">$type</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;log&#39;</span>, <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> (is_string(<span style="color:#ff5c57">$type</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$type</span> <span style="color:#ff6ac1">=</span> preg_replace_callback(<span style="color:#5af78e">&#39;/_([a-zA-Z])/&#39;</span>, <span style="color:#ff6ac1">function</span> (<span style="color:#ff5c57">$matches</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> strtoupper(<span style="color:#ff5c57">$matches</span>[<span style="color:#ff9f43">1</span>]);
</span></span><span style="display:flex;"><span>        }, <span style="color:#ff5c57">$type</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (method_exists(<span style="color:#5af78e">&#39;\think\slog\Slog&#39;</span>, <span style="color:#ff5c57">$type</span>) <span style="color:#ff6ac1">||</span> in_array(<span style="color:#ff5c57">$type</span>, Slog<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$log_types</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>  call_user_func([<span style="color:#5af78e">&#39;\think\slog\Slog&#39;</span>, <span style="color:#ff5c57">$type</span>], <span style="color:#ff5c57">$log</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> (is_object(<span style="color:#ff5c57">$type</span>) <span style="color:#ff6ac1">&amp;&amp;</span> <span style="color:#5af78e">&#39;mysqli&#39;</span> <span style="color:#ff6ac1">==</span> get_class(<span style="color:#ff5c57">$type</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> Slog<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">mysqliLog</span>(<span style="color:#ff5c57">$log</span>, <span style="color:#ff5c57">$type</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> (is_resource(<span style="color:#ff5c57">$type</span>) <span style="color:#ff6ac1">&amp;&amp;</span> (<span style="color:#5af78e">&#39;mysql link&#39;</span> <span style="color:#ff6ac1">==</span> get_resource_type(<span style="color:#ff5c57">$type</span>) <span style="color:#ff6ac1">||</span> <span style="color:#5af78e">&#39;mysql link persistent&#39;</span> <span style="color:#ff6ac1">==</span> get_resource_type(<span style="color:#ff5c57">$type</span>))) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> Slog<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">mysqlLog</span>(<span style="color:#ff5c57">$log</span>, <span style="color:#ff5c57">$type</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">if</span> (is_object(<span style="color:#ff5c57">$type</span>) <span style="color:#ff6ac1">&amp;&amp;</span> <span style="color:#5af78e">&#39;PDO&#39;</span> <span style="color:#ff6ac1">==</span> get_class(<span style="color:#ff5c57">$type</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> Slog<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">pdoLog</span>(<span style="color:#ff5c57">$log</span>, <span style="color:#ff5c57">$type</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">throw</span> <span style="color:#ff6ac1">new</span> Exception(<span style="color:#ff5c57">$type</span> <span style="color:#ff6ac1">.</span> <span style="color:#5af78e">&#39; is not SocketLog method&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="收集调试日志的函数类文件">收集调试日志的函数类文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;?</span>php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e"> * github: https://github.com/luofei614/SocketLog
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e"> * @author luofei614&lt;weibo.com/luofei614&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">namespace</span> think\slog;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff6ac1">class</span> <span style="color:#f3f99d">Slog</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$start_time</span>   <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$start_memory</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$port</span>         <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">1116</span>; <span style="color:#78787e">// SocketLog 服务的 http 的端口号
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$log_types</span>    <span style="color:#ff6ac1">=</span> [<span style="color:#5af78e">&#39;log&#39;</span>, <span style="color:#5af78e">&#39;info&#39;</span>, <span style="color:#5af78e">&#39;error&#39;</span>, <span style="color:#5af78e">&#39;warn&#39;</span>, <span style="color:#5af78e">&#39;table&#39;</span>, <span style="color:#5af78e">&#39;group&#39;</span>, <span style="color:#5af78e">&#39;groupCollapsed&#39;</span>, <span style="color:#5af78e">&#39;groupEnd&#39;</span>, <span style="color:#5af78e">&#39;alert&#39;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$_allowForceClientIds</span> <span style="color:#ff6ac1">=</span> [];    <span style="color:#78787e">// 配置强制推送且被授权的client_id
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$_instance</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$config</span> <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;enable&#39;</span>              <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff6ac1">true</span>,      <span style="color:#78787e">// 是否记录日志的开关
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#5af78e">&#39;host&#39;</span>                <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;localhost&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;optimize&#39;</span>            <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff6ac1">false</span>,     <span style="color:#78787e">// 是否显示利于优化的参数，如果允许时间，消耗内存等
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#5af78e">&#39;show_included_files&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff6ac1">false</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;error_handler&#39;</span>       <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff6ac1">false</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;force_client_ids&#39;</span>    <span style="color:#ff6ac1">=&gt;</span> [],   <span style="color:#78787e">// 日志强制记录到配置的 client_id
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#5af78e">&#39;allow_client_ids&#39;</span>    <span style="color:#ff6ac1">=&gt;</span> []    <span style="color:#78787e">// 限制允许读取日志的client_id
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$logs</span> <span style="color:#ff6ac1">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;sql&#39;</span>           <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;color:#009bb4;&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;sql_warn&#39;</span>      <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;color:#009bb4;font-size:14px;&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;error_handler&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;color:#f4006b;font-size:14px;&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;page&#39;</span>          <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;color:#40e2ff;background:#171717;&#39;</span>
</span></span><span style="display:flex;"><span>    ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * [__callStatic description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $method [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $args   [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]         [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> __callStatic(<span style="color:#ff5c57">$method</span>, <span style="color:#ff5c57">$args</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (in_array(<span style="color:#ff5c57">$method</span>, self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$log_types</span>)) {
</span></span><span style="display:flex;"><span>            array_unshift(<span style="color:#ff5c57">$args</span>, <span style="color:#ff5c57">$method</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$ret</span> <span style="color:#ff6ac1">=</span> call_user_func_array([self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getInstance</span>(), <span style="color:#5af78e">&#39;record&#39;</span>], <span style="color:#ff5c57">$args</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">// 立即发送日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sendLog</span>();
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span> <span style="color:#ff6ac1">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> <span style="color:#ff5c57">$ret</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 显示 SQL 语句调试信息
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $sql  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $link [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]       [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">sql</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$link</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 使用 mysqli 方式连接 DB
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (is_object(<span style="color:#ff5c57">$link</span>) <span style="color:#ff6ac1">&amp;&amp;</span> <span style="color:#5af78e">&#39;mysqli&#39;</span> <span style="color:#ff6ac1">==</span> get_class(<span style="color:#ff5c57">$link</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">mysqliLog</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$link</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 使用 mysql 方式连接 DB
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (is_resource(<span style="color:#ff5c57">$link</span>) <span style="color:#ff6ac1">&amp;&amp;</span> (<span style="color:#5af78e">&#39;mysql link&#39;</span> <span style="color:#ff6ac1">==</span> get_resource_type(<span style="color:#ff5c57">$link</span>) <span style="color:#ff6ac1">||</span> <span style="color:#5af78e">&#39;mysql link persistent&#39;</span> <span style="color:#ff6ac1">==</span> get_resource_type(<span style="color:#ff5c57">$link</span>))) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">mysqlLog</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$link</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 使用 PDO 方式连接 DB
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (is_object(<span style="color:#ff5c57">$link</span>) <span style="color:#ff6ac1">&amp;&amp;</span> <span style="color:#5af78e">&#39;PDO&#39;</span> <span style="color:#ff6ac1">==</span> get_class(<span style="color:#ff5c57">$link</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">pdoLog</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$link</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">throw</span> <span style="color:#ff6ac1">new</span> Exception(<span style="color:#5af78e">&#39;SocketLog can not support this database link&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 增大 log 日志的字体，颜色设置为 red
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $log [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]      [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">big</span>(<span style="color:#ff5c57">$log</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">log</span>(<span style="color:#ff5c57">$log</span>, <span style="color:#5af78e">&#39;font-size:20px;color:red;&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">trace</span>(<span style="color:#ff5c57">$msg</span>, <span style="color:#ff5c57">$trace_level</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">1</span>, <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">groupCollapsed</span>(<span style="color:#ff5c57">$msg</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$traces</span>      <span style="color:#ff6ac1">=</span> debug_backtrace(<span style="color:#ff6ac1">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$traces</span>      <span style="color:#ff6ac1">=</span> array_reverse(<span style="color:#ff5c57">$traces</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$trace_level</span> <span style="color:#ff6ac1">=</span> (<span style="color:#ff5c57">$trace_level</span> <span style="color:#ff6ac1">==</span> <span style="color:#5af78e">&#39;&#39;</span>) <span style="color:#ff6ac1">?</span> <span style="color:#ff9f43">0</span> <span style="color:#ff6ac1">:</span> intval(<span style="color:#ff5c57">$trace_level</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$max</span>         <span style="color:#ff6ac1">=</span> count(<span style="color:#ff5c57">$traces</span>) <span style="color:#ff6ac1">-</span> <span style="color:#ff5c57">$trace_level</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">for</span> (<span style="color:#ff5c57">$i</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff9f43">0</span>; <span style="color:#ff5c57">$i</span> <span style="color:#ff6ac1">&lt;</span> <span style="color:#ff5c57">$max</span>; <span style="color:#ff5c57">$i</span><span style="color:#ff6ac1">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$trace</span>     <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">$traces</span>[<span style="color:#ff5c57">$i</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$fun</span>       <span style="color:#ff6ac1">=</span> isset(<span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;class&#39;</span>]) <span style="color:#ff6ac1">?</span> <span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;class&#39;</span>] <span style="color:#ff6ac1">.</span> <span style="color:#5af78e">&#39;::&#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;function&#39;</span>] <span style="color:#ff6ac1">:</span> <span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;function&#39;</span>];
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$file</span>      <span style="color:#ff6ac1">=</span> isset(<span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;file&#39;</span>]) <span style="color:#ff6ac1">?</span> <span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;file&#39;</span>] <span style="color:#ff6ac1">:</span> <span style="color:#5af78e">&#39;unknown file&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$line</span>      <span style="color:#ff6ac1">=</span> isset(<span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;line&#39;</span>]) <span style="color:#ff6ac1">?</span> <span style="color:#ff5c57">$trace</span>[<span style="color:#5af78e">&#39;line&#39;</span>] <span style="color:#ff6ac1">:</span> <span style="color:#5af78e">&#39;unknown line&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$trace_msg</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;#&#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$i</span> <span style="color:#ff6ac1">.</span> <span style="color:#5af78e">&#39;  &#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$fun</span> <span style="color:#ff6ac1">.</span> <span style="color:#5af78e">&#39; called at [&#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$file</span> <span style="color:#ff6ac1">.</span> <span style="color:#5af78e">&#39;:&#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$line</span> <span style="color:#ff6ac1">.</span> <span style="color:#5af78e">&#39;]&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">//不输出参数速度会有明显的改善
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#78787e">//if(!empty($trace[&#39;args&#39;])){
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#78787e">//    self::groupCollapsed($trace_msg);
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#78787e">//    self::log($trace[&#39;args&#39;]);
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#78787e">//    self::groupEnd();
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#78787e">//}else{
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">log</span>(<span style="color:#ff5c57">$trace_msg</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">//}
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">groupEnd</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 使用 mysqli 对象的 Log
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $sql [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $db  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]      [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">mysqliLog</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$db</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;sql&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (preg_match(<span style="color:#5af78e">&#39;/^SELECT /i&#39;</span>, <span style="color:#ff5c57">$sql</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">// 对传入的查询语句执行 explain
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#ff5c57">$query</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">@</span>mysqli_query(<span style="color:#ff5c57">$db</span>, <span style="color:#5af78e">&#34;EXPLAIN &#34;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$sql</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$arr</span>   <span style="color:#ff6ac1">=</span> mysqli_fetch_array(<span style="color:#ff5c57">$query</span>);
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sqlExplain</span>(<span style="color:#ff5c57">$arr</span>, <span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sqlWhere</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">trace</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 使用 mysql 对象的 Log
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $sql [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $db  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]      [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">mysqlLog</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$db</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;sql&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (preg_match(<span style="color:#5af78e">&#39;/^SELECT /i&#39;</span>, <span style="color:#ff5c57">$sql</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">// 对传入的查询语句执行 explain
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#ff5c57">$query</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">@</span>mysql_query(<span style="color:#5af78e">&#34;EXPLAIN &#34;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$db</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$arr</span>   <span style="color:#ff6ac1">=</span> mysql_fetch_array(<span style="color:#ff5c57">$query</span>);
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sqlExplain</span>(<span style="color:#ff5c57">$arr</span>, <span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">//判断sql语句是否有where
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sqlWhere</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">trace</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 使用 PDO 对象的 Log
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $sql [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $db  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]      [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">pdoLog</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$pdo</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;sql&#39;</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (preg_match(<span style="color:#5af78e">&#39;/^SELECT /i&#39;</span>, <span style="color:#ff5c57">$sql</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">//explain
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#ff6ac1">try</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$obj</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">$pdo</span><span style="color:#ff6ac1">-&gt;</span><span style="color:#57c7ff">query</span>(<span style="color:#5af78e">&#34;EXPLAIN &#34;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$sql</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">if</span> (is_object(<span style="color:#ff5c57">$obj</span>) <span style="color:#ff6ac1">&amp;&amp;</span> method_exists(<span style="color:#ff5c57">$obj</span>, <span style="color:#5af78e">&#39;fetch&#39;</span>)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#ff5c57">$arr</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">$obj</span><span style="color:#ff6ac1">-&gt;</span><span style="color:#57c7ff">fetch</span>(\PDO<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">FETCH_ASSOC</span>);
</span></span><span style="display:flex;"><span>                    self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sqlExplain</span>(<span style="color:#ff5c57">$arr</span>, <span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#ff6ac1">catch</span> (Exception <span style="color:#ff5c57">$e</span>) {
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sqlWhere</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">trace</span>(<span style="color:#ff5c57">$sql</span>, <span style="color:#ff9f43">2</span>, <span style="color:#ff5c57">$css</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 对 SQL 语句执行 Explain 解析
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $arr  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] &amp;$sql [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] &amp;$css [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]       [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 优化案例：https://blog.csdn.net/canot/article/details/104920558
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">private</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">sqlExplain</span>(<span style="color:#ff5c57">$arr</span>, <span style="color:#ff6ac1">&amp;</span><span style="color:#ff5c57">$sql</span>, <span style="color:#ff6ac1">&amp;</span><span style="color:#ff5c57">$css</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$arr</span> <span style="color:#ff6ac1">=</span> array_change_key_case(<span style="color:#ff5c57">$arr</span>, CASE_LOWER);
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// https://www.cnblogs.com/lcngu/p/6023214.html
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#78787e">// Using filesort 是指查询完成之前还需要“额外的一次排序”
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#78787e">// filesort主要用于查询数据结果集的排序操作，首先MySQL会使用sort_buffer_size大小的内存进行排序
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#78787e">// 如果结果集超过了sort_buffer_size大小，会把这一个排序后的chunk转移到file上，最后使用多路归并排序完成所有数据的排序操作。
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">false</span> <span style="color:#ff6ac1">!==</span> strpos(<span style="color:#ff5c57">$arr</span>[<span style="color:#5af78e">&#39;extra&#39;</span>], <span style="color:#5af78e">&#39;Using filesort&#39;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$sql</span> <span style="color:#ff6ac1">.=</span> <span style="color:#5af78e">&#39; &lt;---################[Using filesort]&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;sql_warn&#39;</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// MySQL使用临时表保存临时的结构，以用于后续的处理，MySQL首先创建heap引擎的临时表
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#78787e">// 如果临时的数据过多，超过max_heap_table_size的大小，会自动把临时表转换成MyISAM引擎的表来使用。
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">false</span> <span style="color:#ff6ac1">!==</span> strpos(<span style="color:#ff5c57">$arr</span>[<span style="color:#5af78e">&#39;extra&#39;</span>], <span style="color:#5af78e">&#39;Using temporary&#39;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$sql</span> <span style="color:#ff6ac1">.=</span> <span style="color:#5af78e">&#39; &lt;---################[Using temporary]&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;sql_warn&#39;</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 检查 SQL 语句是否还有 Where 条件，如果不含有则显示 warn 信息
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] &amp;$sql [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] &amp;$css [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]       [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">private</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">sqlWhere</span>(<span style="color:#ff6ac1">&amp;</span><span style="color:#ff5c57">$sql</span>, <span style="color:#ff6ac1">&amp;</span><span style="color:#ff5c57">$css</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 判断 SQL 语句是否有 where 条件
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (preg_match(<span style="color:#5af78e">&#39;/^UPDATE | DELETE /i&#39;</span>, <span style="color:#ff5c57">$sql</span>) <span style="color:#ff6ac1">&amp;&amp;</span> <span style="color:#ff6ac1">!</span>preg_match(<span style="color:#5af78e">&#39;/WHERE.*(=|&gt;|&lt;|LIKE|IN)/i&#39;</span>, <span style="color:#ff5c57">$sql</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$sql</span> <span style="color:#ff6ac1">.=</span> <span style="color:#5af78e">&#39;&lt;---###########[NO WHERE]&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;sql_warn&#39;</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 接管报错
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">registerErrorHandler</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 自定义的错误处理
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        set_error_handler([<span style="color:#ff9f43">__CLASS__</span>, <span style="color:#5af78e">&#39;errorHandler&#39;</span>]);
</span></span><span style="display:flex;"><span>        register_shutdown_function([<span style="color:#ff9f43">__CLASS__</span>, <span style="color:#5af78e">&#39;fatalError&#39;</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 设置错误处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $errno   [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $errstr  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $errfile [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $errline [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]          [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">errorHandler</span>(<span style="color:#ff5c57">$errno</span>, <span style="color:#ff5c57">$errstr</span>, <span style="color:#ff5c57">$errfile</span>, <span style="color:#ff5c57">$errline</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">switch</span> (<span style="color:#ff5c57">$errno</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> <span style="color:#ff6ac1">E_WARNING</span><span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_WARNING&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_NOTICE<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_NOTICE&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_USER_ERROR<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_USER_ERROR&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_USER_WARNING<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_USER_WARNING&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_USER_NOTICE<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_USER_NOTICE&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_STRICT<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_STRICT&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_RECOVERABLE_ERROR<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_RECOVERABLE_ERROR&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_DEPRECATED<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_DEPRECATED&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_USER_DEPRECATED<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_USER_DEPRECATED&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> <span style="color:#ff6ac1">E_ERROR</span><span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_ERR&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> <span style="color:#ff6ac1">E_PARSE</span><span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_PARSE&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_CORE_ERROR<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_CORE_ERROR&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_COMPILE_ERROR<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_COMPILE_ERROR&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">case</span> E_USER_ERROR<span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_USER_ERROR&#39;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">default</span><span style="color:#ff6ac1">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$severity</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;E_UNKNOWN_ERROR_&#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$errno</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$msg</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;</span><span style="color:#5af78e">{</span><span style="color:#ff5c57">$severity</span><span style="color:#5af78e">}</span><span style="color:#5af78e">: </span><span style="color:#5af78e">{</span><span style="color:#ff5c57">$errstr</span><span style="color:#5af78e">}</span><span style="color:#5af78e"> in </span><span style="color:#5af78e">{</span><span style="color:#ff5c57">$errfile</span><span style="color:#5af78e">}</span><span style="color:#5af78e"> on line </span><span style="color:#5af78e">{</span><span style="color:#ff5c57">$errline</span><span style="color:#5af78e">}</span><span style="color:#5af78e"> -- SocketLog error handler&#34;</span>;
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">trace</span>(<span style="color:#ff5c57">$msg</span>, <span style="color:#ff9f43">2</span>, self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;error_handler&#39;</span>]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * Fatal Error 函数
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type] [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">fatalError</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 保存日志记录
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff5c57">$e</span> <span style="color:#ff6ac1">=</span> error_get_last()) {
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">errorHandler</span>(<span style="color:#ff5c57">$e</span>[<span style="color:#5af78e">&#39;type&#39;</span>], <span style="color:#ff5c57">$e</span>[<span style="color:#5af78e">&#39;message&#39;</span>], <span style="color:#ff5c57">$e</span>[<span style="color:#5af78e">&#39;file&#39;</span>], <span style="color:#ff5c57">$e</span>[<span style="color:#5af78e">&#39;line&#39;</span>]);
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sendLog</span>(); <span style="color:#78787e">// 此类终止不会调用类的 __destruct 方法，所以此处手动 sendLog
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 获取实例
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type] [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">getInstance</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_instance</span> <span style="color:#ff6ac1">===</span> <span style="color:#ff6ac1">null</span>) {
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_instance</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">new</span> self();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_instance</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 执行检查
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type] [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">check</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getConfig</span>(<span style="color:#5af78e">&#39;enable&#39;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 获取 客户端 请求头 中的 tabeid
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff5c57">$tabid</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getClientArg</span>(<span style="color:#5af78e">&#39;tabid&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 是否记录日志的检查
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span><span style="color:#ff5c57">$tabid</span> <span style="color:#ff6ac1">&amp;&amp;</span> <span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getConfig</span>(<span style="color:#5af78e">&#39;force_client_ids&#39;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">false</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 用户认证
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff5c57">$allow_client_ids</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getConfig</span>(<span style="color:#5af78e">&#39;allow_client_ids&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span><span style="color:#ff6ac1">empty</span>(<span style="color:#ff5c57">$allow_client_ids</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">// 通过数组交集运算，得出授权强制推送的 client_id
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_allowForceClientIds</span> <span style="color:#ff6ac1">=</span> array_intersect(<span style="color:#ff5c57">$allow_client_ids</span>, self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getConfig</span>(<span style="color:#5af78e">&#39;force_client_ids&#39;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">// 为空就是所有的客户端都可看到调试日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span><span style="color:#ff5c57">$tabid</span> <span style="color:#ff6ac1">&amp;&amp;</span> count(self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_allowForceClientIds</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$client_id</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getClientArg</span>(<span style="color:#5af78e">&#39;client_id&#39;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>in_array(<span style="color:#ff5c57">$client_id</span>, <span style="color:#ff5c57">$allow_client_ids</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">false</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_allowForceClientIds</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getConfig</span>(<span style="color:#5af78e">&#39;force_client_ids&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 获取客户端参数
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $name [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]       [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">getClientArg</span>(<span style="color:#ff5c57">$name</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">static</span> <span style="color:#ff5c57">$args</span> <span style="color:#ff6ac1">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$key</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;HTTP_USER_AGENT&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (isset(<span style="color:#ff5c57">$_SERVER</span>[<span style="color:#5af78e">&#39;HTTP_SOCKETLOG&#39;</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$key</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;HTTP_SOCKETLOG&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>isset(<span style="color:#ff5c57">$_SERVER</span>[<span style="color:#ff5c57">$key</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// 通过正则匹配去获取 tabid 与 client_id
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">empty</span>(<span style="color:#ff5c57">$args</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>preg_match(<span style="color:#5af78e">&#39;/SocketLog\((.*?)\)/&#39;</span>, <span style="color:#ff5c57">$_SERVER</span>[<span style="color:#ff5c57">$key</span>], <span style="color:#ff5c57">$match</span>)) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$args</span> <span style="color:#ff6ac1">=</span> [<span style="color:#5af78e">&#39;tabid&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff6ac1">null</span>];
</span></span><span style="display:flex;"><span>                <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">null</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            parse_str(<span style="color:#ff5c57">$match</span>[<span style="color:#ff9f43">1</span>], <span style="color:#ff5c57">$args</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (isset(<span style="color:#ff5c57">$args</span>[<span style="color:#ff5c57">$name</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> <span style="color:#ff5c57">$args</span>[<span style="color:#ff5c57">$name</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 按需设置项目的调试配置项
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $config [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]         [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">config</span>(<span style="color:#ff5c57">$config</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$config</span> <span style="color:#ff6ac1">=</span> array_merge(self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$config</span>, <span style="color:#ff5c57">$config</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$config</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">$config</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getInstance</span>(); <span style="color:#78787e">// 强制初始化 SocketLog 实例
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> (<span style="color:#ff5c57">$config</span>[<span style="color:#5af78e">&#39;optimize&#39;</span>]) {
</span></span><span style="display:flex;"><span>                self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$start_time</span>   <span style="color:#ff6ac1">=</span> microtime(<span style="color:#ff6ac1">true</span>);
</span></span><span style="display:flex;"><span>                self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$start_memory</span> <span style="color:#ff6ac1">=</span> memory_get_usage();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">if</span> (<span style="color:#ff5c57">$config</span>[<span style="color:#5af78e">&#39;error_handler&#39;</span>]) {
</span></span><span style="display:flex;"><span>                self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">registerErrorHandler</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 获取配置项
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $name [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]       [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">getConfig</span>(<span style="color:#ff5c57">$name</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (isset(self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$config</span>[<span style="color:#ff5c57">$name</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$config</span>[<span style="color:#ff5c57">$name</span>];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 记录日志
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  [type] $type [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  string $msg  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param  string $css  [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type]       [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">record</span>(<span style="color:#ff5c57">$type</span>, <span style="color:#ff5c57">$msg</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>, <span style="color:#ff5c57">$css</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>[] <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;type&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$type</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;msg&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$msg</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;css&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$css</span>
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 调试后台 API 时，发送信息
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param null $host - $host of socket server
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param string $message - 发送的消息
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param string $address - 地址
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return bool
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">send</span>(<span style="color:#ff5c57">$host</span>, <span style="color:#ff5c57">$message</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>, <span style="color:#ff5c57">$address</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;/&#39;</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$url</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;http://&#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$host</span> <span style="color:#ff6ac1">.</span> <span style="color:#5af78e">&#39;:&#39;</span> <span style="color:#ff6ac1">.</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$port</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$address</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$ch</span>  <span style="color:#ff6ac1">=</span> curl_init();
</span></span><span style="display:flex;"><span>        curl_setopt(<span style="color:#ff5c57">$ch</span>, CURLOPT_URL, <span style="color:#ff5c57">$url</span>);
</span></span><span style="display:flex;"><span>        curl_setopt(<span style="color:#ff5c57">$ch</span>, CURLOPT_POST, <span style="color:#ff6ac1">true</span>);
</span></span><span style="display:flex;"><span>        curl_setopt(<span style="color:#ff5c57">$ch</span>, CURLOPT_POSTFIELDS, <span style="color:#ff5c57">$message</span>);
</span></span><span style="display:flex;"><span>        curl_setopt(<span style="color:#ff5c57">$ch</span>, CURLOPT_RETURNTRANSFER, <span style="color:#ff6ac1">true</span>);
</span></span><span style="display:flex;"><span>        curl_setopt(<span style="color:#ff5c57">$ch</span>, CURLOPT_CONNECTTIMEOUT, <span style="color:#ff9f43">1</span>);
</span></span><span style="display:flex;"><span>        curl_setopt(<span style="color:#ff5c57">$ch</span>, CURLOPT_TIMEOUT, <span style="color:#ff9f43">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$headers</span> <span style="color:#ff6ac1">=</span> [<span style="color:#5af78e">&#34;Content-Type: application/json;charset=UTF-8&#34;</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        curl_setopt(<span style="color:#ff5c57">$ch</span>, CURLOPT_HTTPHEADER, <span style="color:#ff5c57">$headers</span>); <span style="color:#78787e">// 设置 header
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#ff5c57">$txt</span> <span style="color:#ff6ac1">=</span> curl_exec(<span style="color:#ff5c57">$ch</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">return</span> <span style="color:#ff6ac1">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 发送 Log
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @return [type] [description]
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">sendLog</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span>self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">check</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff6ac1">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$time_str</span>   <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$memory_str</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$start_time</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$runtime</span>  <span style="color:#ff6ac1">=</span> microtime(<span style="color:#ff6ac1">true</span>) <span style="color:#ff6ac1">-</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$start_time</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$reqs</span>     <span style="color:#ff6ac1">=</span> number_format(<span style="color:#ff9f43">1</span> <span style="color:#ff6ac1">/</span> <span style="color:#ff5c57">$runtime</span>, <span style="color:#ff9f43">2</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$time_str</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;[运行时间：</span><span style="color:#5af78e">{</span><span style="color:#ff5c57">$runtime</span><span style="color:#5af78e">}</span><span style="color:#5af78e">s][吞吐率：</span><span style="color:#5af78e">{</span><span style="color:#ff5c57">$reqs</span><span style="color:#5af78e">}</span><span style="color:#5af78e">req/s]&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$start_memory</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$memory_use</span> <span style="color:#ff6ac1">=</span> number_format((memory_get_usage() <span style="color:#ff6ac1">-</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$start_memory</span>) <span style="color:#ff6ac1">/</span> <span style="color:#ff9f43">1024</span>, <span style="color:#ff9f43">2</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$memory_str</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;[内存消耗：</span><span style="color:#5af78e">{</span><span style="color:#ff5c57">$memory_use</span><span style="color:#5af78e">}</span><span style="color:#5af78e">kb]&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (isset(<span style="color:#ff5c57">$_SERVER</span>[<span style="color:#5af78e">&#39;HTTP_HOST&#39;</span>])) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$current_uri</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">$_SERVER</span>[<span style="color:#5af78e">&#39;HTTP_HOST&#39;</span>] <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$_SERVER</span>[<span style="color:#5af78e">&#39;REQUEST_URI&#39;</span>];
</span></span><span style="display:flex;"><span>        } <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$current_uri</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#34;cmd:&#34;</span> <span style="color:#ff6ac1">.</span> implode(<span style="color:#5af78e">&#39; &#39;</span>, <span style="color:#ff5c57">$_SERVER</span>[<span style="color:#5af78e">&#39;argv&#39;</span>]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        array_unshift(self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>, [
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;type&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;group&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;msg&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$current_uri</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$time_str</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$memory_str</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;css&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$css</span>[<span style="color:#5af78e">&#39;page&#39;</span>]
</span></span><span style="display:flex;"><span>        ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getConfig</span>(<span style="color:#5af78e">&#39;show_included_files&#39;</span>)) {
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>[] <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;type&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;groupCollapsed&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;msg&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;included_files&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;css&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>            ];
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>[] <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;type&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;log&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;msg&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> implode(<span style="color:#5af78e">&#34;</span><span style="color:#5af78e">\n</span><span style="color:#5af78e">&#34;</span>, get_included_files()),
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;css&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>            ];
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>[] <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;type&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;groupEnd&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;msg&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#5af78e">&#39;css&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>            ];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>[] <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;type&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;groupEnd&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;msg&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;css&#39;</span>  <span style="color:#ff6ac1">=&gt;</span> <span style="color:#5af78e">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$tabid</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getClientArg</span>(<span style="color:#5af78e">&#39;tabid&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span><span style="color:#ff5c57">$client_id</span> <span style="color:#ff6ac1">=</span> self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getClientArg</span>(<span style="color:#5af78e">&#39;client_id&#39;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#ff5c57">$client_id</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff6ac1">if</span> (<span style="color:#ff6ac1">!</span><span style="color:#ff6ac1">empty</span>(self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_allowForceClientIds</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#78787e">// 强制推送到多个 client_id
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>            <span style="color:#ff6ac1">foreach</span> (self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_allowForceClientIds</span> <span style="color:#ff6ac1">as</span> <span style="color:#ff5c57">$force_client_id</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#ff5c57">$client_id</span> <span style="color:#ff6ac1">=</span> <span style="color:#ff5c57">$force_client_id</span>;
</span></span><span style="display:flex;"><span>                self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sendToClient</span>(<span style="color:#ff5c57">$tabid</span>, <span style="color:#ff5c57">$client_id</span>, self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>, <span style="color:#ff5c57">$force_client_id</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#ff6ac1">else</span> {
</span></span><span style="display:flex;"><span>            self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">sendToClient</span>(<span style="color:#ff5c57">$tabid</span>, <span style="color:#ff5c57">$client_id</span>, self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$logs</span>, <span style="color:#5af78e">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * 发送给指定客户端
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @author Zjmainstay
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param $tabid
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param $client_id
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param $logs
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     * @param $force_client_id
</span></span></span><span style="display:flex;"><span><span style="color:#5af78e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">protected</span> <span style="color:#ff6ac1">static</span> <span style="color:#ff6ac1">function</span> <span style="color:#57c7ff">sendToClient</span>(<span style="color:#ff5c57">$tabid</span>, <span style="color:#ff5c57">$client_id</span>, <span style="color:#ff5c57">$logs</span>, <span style="color:#ff5c57">$force_client_id</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$logs</span> <span style="color:#ff6ac1">=</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;tabid&#39;</span>           <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$tabid</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;client_id&#39;</span>       <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$client_id</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;logs&#39;</span>            <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$logs</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#5af78e">&#39;force_client_id&#39;</span> <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff5c57">$force_client_id</span>,
</span></span><span style="display:flex;"><span>        ];
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$msg</span>     <span style="color:#ff6ac1">=</span> <span style="color:#ff6ac1">@</span>json_encode(<span style="color:#ff5c57">$logs</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#ff5c57">$address</span> <span style="color:#ff6ac1">=</span> <span style="color:#5af78e">&#39;/&#39;</span> <span style="color:#ff6ac1">.</span> <span style="color:#ff5c57">$client_id</span>; <span style="color:#78787e">// 将 client_id 作为地址，server 端通过地址判断将日志发布给谁
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">send</span>(self<span style="color:#ff6ac1">::</span><span style="color:#57c7ff">getConfig</span>(<span style="color:#5af78e">&#39;host&#39;</span>), <span style="color:#ff5c57">$msg</span>, <span style="color:#ff5c57">$address</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">public</span> <span style="color:#ff6ac1">function</span> __destruct()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#78787e">// self::sendLog();
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="安装与使用">安装与使用</h2>
<h3 id="安装">安装</h3>
<blockquote>
<p>客户端：</p>
<p>方法一：打开 <a class="link" href="https://chrome.google.com/webstore/category/extensions?hl=zh-CN"  title="Chrome 网上应用店"
     target="_blank" rel="noopener"
    >Chrome 网上应用店</a> 或 <a class="link" href="https://addons.mozilla.org/zh-CN/firefox/search/?q=SocketLog"  title="Firefox扩展"
     target="_blank" rel="noopener"
    >Firefox扩展</a>，搜索 SocketLog ，然后点击添加 完成安装。如果不能正常访问 Chrome 网上应用店，可以尝试如下的手动安装方法。</p>
<p>方法二：在 GitHub 上下载 <a class="link" href="https://github.com/luofei614/SocketLog"  title="chrome.crx"
     target="_blank" rel="noopener"
    >chrome.crx</a>，打开浏览器地址栏并输入：chrome://extensions，将chrome.crx 拖入打开的页面即可。</p>
</blockquote>
<blockquote>
<p>服务端（安装 Socket 服务并启动【需要安装 NodeJs】）:</p>
<p>方法一：npm 方式安装</p>
<p>全局安装：npm install -g socketlog-server</p>
<p>局部安装：npm install socketlog-server【需切换到指定目录】</p>
<p>启动服务：
普通方式 =&gt; socketlog-server、挂起模式 =&gt; socketlog-server &gt; /dev/null &amp;</p>
<p>方法二：源码方式安装</p>
<p>目标项目所在目录执行：git clone <a class="link" href="https://github.com/luofei614/SocketLog.git"  target="_blank" rel="noopener"
    >https://github.com/luofei614/SocketLog.git</a></p>
<p>启动方式：node server/index.js</p>
</blockquote>
<h3 id="引入探针文件">引入探针文件</h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;?</span>php
</span></span><span style="display:flex;"><span><span style="color:#78787e">// 根据实际情况，确定源码的 php 目录放置位置，在需要调试的文件中引入
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff6ac1">include</span> <span style="color:#5af78e">&#39;./php/slog.function.php&#39;</span>;
</span></span><span style="display:flex;"><span>slog(<span style="color:#5af78e">&#39;hello world&#39;</span>);
</span></span></code></pre></div><h3 id="端口占用说明">端口占用说明</h3>
<ul>
<li>
<p>WebSocket 服务端监听端口是 1229</p>
</li>
<li>
<p>如果服务器有防火墙需放行 1229 与 1116【SocketLog 服务的 http 端口】 两个端口</p>
</li>
</ul>
<h3 id="设置-client_idclient_id-可以是你任意指定的字符串">设置 client_id【client_id 可以是你任意指定的字符串】</h3>
<p><img src="/SocketLog/img/socketlog.png"
	width="185"
	height="281"
	srcset="/SocketLog/img/socketlog_hu4d45d467f9cb338dced231e5dbb056ed_33344_480x0_resize_mitchellnetravali_3.png 480w, /SocketLog/img/socketlog_hu4d45d467f9cb338dced231e5dbb056ed_33344_1024x0_resize_mitchellnetravali_3.png 1024w"
	loading="lazy"
	
		alt="SocketLog"
	
	
		class="gallery-image" 
		data-flex-grow="65"
		data-flex-basis="158px"
	
></p>
<blockquote>
<p>设置 client_id 后可以实现以下功能：<br>
1、通过 allow_client_ids 配置项 来 允许指定的浏览器获取日志，这样就可以把调试代码待上线，普通用户不会触发调试也不会收到调试日志，而开发人员可以看到，有利于调试线上bug<br>
2、对于不和浏览器接触的后台脚本【消息队列】，我们可以通过 allow_client_ids 配置项将日志打印到指定的浏览器 来 区分 是哪个浏览器触发了后台脚本</p>
</blockquote>
<h2 id="示例">示例</h2>
<h3 id="日志类型">日志类型</h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>slog(<span style="color:#5af78e">&#39;一般日志&#39;</span>,<span style="color:#5af78e">&#39;log&#39;</span>);      <span style="color:#78787e">// 一般日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(<span style="color:#5af78e">&#39;错误日志&#39;</span>,<span style="color:#5af78e">&#39;error&#39;</span>);    <span style="color:#78787e">// 错误日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(<span style="color:#5af78e">&#39;信息日志&#39;</span>,<span style="color:#5af78e">&#39;info&#39;</span>);     <span style="color:#78787e">// 信息日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(<span style="color:#5af78e">&#39;警告日志&#39;</span>,<span style="color:#5af78e">&#39;warn&#39;</span>);     <span style="color:#78787e">// 警告日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(<span style="color:#5af78e">&#39;输出调用栈日志&#39;</span>,<span style="color:#5af78e">&#39;trace&#39;</span>);    <span style="color:#78787e">// 输出日志,同时打出调用栈
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(<span style="color:#5af78e">&#39;alert形式&#39;</span>,<span style="color:#5af78e">&#39;alert&#39;</span>);    <span style="color:#78787e">// 日志将以 alert 形式弹出
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(<span style="color:#5af78e">&#39;自定义样式日志&#39;</span>,<span style="color:#5af78e">&#39;log&#39;</span>,<span style="color:#5af78e">&#39;color:red;font-size:20px;&#39;</span>);    <span style="color:#78787e">// 自定义样式
</span></span></span></code></pre></div><p><img src="/SocketLog/img/SocketLog_Sample.png"
	width="1919"
	height="747"
	srcset="/SocketLog/img/SocketLog_Sample_huef4a9976d247fdf105029710fc1a7f47_105911_480x0_resize_mitchellnetravali_3.png 480w, /SocketLog/img/SocketLog_Sample_huef4a9976d247fdf105029710fc1a7f47_105911_1024x0_resize_mitchellnetravali_3.png 1024w"
	loading="lazy"
	
		alt="Demo"
	
	
		class="gallery-image" 
		data-flex-grow="256"
		data-flex-basis="616px"
	
></p>
<h3 id="其他配置项">其他配置项</h3>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#ff6ac1">&lt;?</span>php
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>slog(
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">array</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;enable&#39;</span>                <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">true</span>,                   <span style="color:#78787e">//  是否打印日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#5af78e">&#39;host&#39;</span>                  <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#5af78e">&#39;localhost&#39;</span>,            <span style="color:#78787e">//  Websocket 服务器地址,默认为本地
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#5af78e">&#39;optimize&#39;</span>              <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">true</span>,                   <span style="color:#78787e">//  是否显示有利于程序优化的信息,如运行时间、吞吐率、消耗内存、等,默认为 false
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#5af78e">&#39;show_included_files&#39;</span>   <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">true</span>,                   <span style="color:#78787e">//  是否显示本次运行加载了那些文件,默认为 false
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>        <span style="color:#5af78e">&#39;error_handler&#39;</span>         <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">true</span>,                   <span style="color:#78787e">//  是否接管程序异常处理
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>       <span style="color:#5af78e">&#39;force_client_id&#39;</span>       <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#5af78e">&#39;shentong_abcdefg&#39;</span>,     <span style="color:#78787e">//  日志强制输出到配置的 client_id 默认为空
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>
</span></span><span style="display:flex;"><span>       <span style="color:#78787e">//  限制允许读取日志的 client_id，默认为空，表示所有人都可以获得日志
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>       <span style="color:#5af78e">&#39;allow_client_ids&#39;</span>      <span style="color:#ff6ac1">=&gt;</span> <span style="color:#ff6ac1">array</span>(<span style="color:#5af78e">&#39;shentong_abcdefg&#39;</span>,<span style="color:#5af78e">&#39;stt_test&#39;</span>),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#39;config&#39;</span>,
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// 触发一个报错
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span><span style="color:#ff6ac1">echo</span> notice;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>slog(<span style="color:#5af78e">&#39;一般日志&#39;</span>);
</span></span></code></pre></div><ul>
<li>Optimize：调优信息</li>
</ul>
<p><img src="/SocketLog/img/socketlog_optimize.png"
	width="1920"
	height="224"
	srcset="/SocketLog/img/socketlog_optimize_hu553b1c524580ce4249bc23ef779d9cd0_33299_480x0_resize_mitchellnetravali_3.png 480w, /SocketLog/img/socketlog_optimize_hu553b1c524580ce4249bc23ef779d9cd0_33299_1024x0_resize_mitchellnetravali_3.png 1024w"
	loading="lazy"
	
		alt="Optimize"
	
	
		class="gallery-image" 
		data-flex-grow="857"
		data-flex-basis="2057px"
	
></p>
<ul>
<li>Show_included_files：所有引入文件</li>
</ul>
<p><img src="/SocketLog/img/show_included_files.png"
	width="1920"
	height="398"
	srcset="/SocketLog/img/show_included_files_hu7914dea756f3a13b9d1a661d251e6118_49386_480x0_resize_mitchellnetravali_3.png 480w, /SocketLog/img/show_included_files_hu7914dea756f3a13b9d1a661d251e6118_49386_1024x0_resize_mitchellnetravali_3.png 1024w"
	loading="lazy"
	
		alt="show included files"
	
	
		class="gallery-image" 
		data-flex-grow="482"
		data-flex-basis="1157px"
	
></p>
<ul>
<li>Error_handler：接管程序的异常处理</li>
</ul>
<p><img src="/SocketLog/img/error_handler.png"
	width="1906"
	height="495"
	srcset="/SocketLog/img/error_handler_hu80f45a376fbf957ec992d7fa0ab1506f_86680_480x0_resize_mitchellnetravali_3.png 480w, /SocketLog/img/error_handler_hu80f45a376fbf957ec992d7fa0ab1506f_86680_1024x0_resize_mitchellnetravali_3.png 1024w"
	loading="lazy"
	
		alt="error handler"
	
	
		class="gallery-image" 
		data-flex-grow="385"
		data-flex-basis="924px"
	
></p>
<h2 id="sql-调试">Sql 调试</h2>
<p>SocketLog 还能对 SQL 语句进行调试，自动对 SQL 语句进行 explain 分析，打印出有性能问题的 SQL 语句。</p>
<div class="highlight"><pre tabindex="0" style="color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#78787e">// 打印sql
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(
</span></span><span style="display:flex;"><span>    <span style="color:#ff6ac1">array</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;allow_client_ids&#39;</span>      <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">array</span>(<span style="color:#5af78e">&#39;shentong_abcdefg&#39;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;enable&#39;</span>                <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;optimize&#39;</span>              <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">false</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;show_included_files&#39;</span>   <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">false</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#5af78e">&#39;error_handler&#39;</span>         <span style="color:#ff6ac1">=&gt;</span>  <span style="color:#ff6ac1">false</span>,
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    <span style="color:#5af78e">&#39;config&#39;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#78787e">// 第一个参数：sql 语句
</span></span></span><span style="display:flex;"><span><span style="color:#78787e">// 第二个参数：mysql、mysqli 或 PDO的连接对象
</span></span></span><span style="display:flex;"><span><span style="color:#78787e"></span>slog(<span style="color:#ff5c57">$sql</span>,self<span style="color:#ff6ac1">::</span><span style="color:#ff5c57">$_db</span>);
</span></span></code></pre></div><p><img src="/SocketLog/img/sql_1.png"
	width="1919"
	height="508"
	srcset="/SocketLog/img/sql_1_hu62246cfefbc2bb0b06a7c5f7f5c180e7_91720_480x0_resize_mitchellnetravali_3.png 480w, /SocketLog/img/sql_1_hu62246cfefbc2bb0b06a7c5f7f5c180e7_91720_1024x0_resize_mitchellnetravali_3.png 1024w"
	loading="lazy"
	
		alt="sql"
	
	
		class="gallery-image" 
		data-flex-grow="377"
		data-flex-basis="906px"
	
></p>
<p><img src="/SocketLog/img/sql_2.png"
	width="960"
	height="276"
	srcset="/SocketLog/img/sql_2_hu31f2520c2a056e7eb18001410338f887_78271_480x0_resize_mitchellnetravali_3.png 480w, /SocketLog/img/sql_2_hu31f2520c2a056e7eb18001410338f887_78271_1024x0_resize_mitchellnetravali_3.png 1024w"
	loading="lazy"
	
		alt="sql"
	
	
		class="gallery-image" 
		data-flex-grow="347"
		data-flex-basis="834px"
	
></p>
<blockquote>
<p>1）对于有性能问题的 SQL，SocketLog 会将 SQL 字体做放大标识<br>
2）SocketLog 也会打印出每个 SQL 的调用栈信息</p>
</blockquote>
<h3 id="端口-与-执行流程">端口 与 执行流程</h3>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>端口</th>
<th>执行流程</th>
</tr>
</thead>
<tbody>
<tr>
<td>1116</td>
<td>web 通过 该端口将 信息 发送至 http 协议的 workerman 服务</td>
</tr>
<tr>
<td>2206</td>
<td>创建并监听本地管道服务端口，通过该端口 连接管道服务 并将接收到的信息 通过 broadcast【广播】 事件 的形式放至管道【相当于给监听该管道服务的 workamn 进程发送信息】</td>
</tr>
<tr>
<td>1229</td>
<td>websocket 推送端口：创建一个 ws 协议的 worker、监听该端口并连接管道服务【由于 workman 无法触发对端事件(无法自定义事件)，所以这里只能与浏览器客户端建立连接，将通过管道服务接收到的数据推送给浏览器】</td>
</tr>
</tbody>
</table></div>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>true</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            1997 - 
        
        2023 
    </section>
    
    <section class="powerby">
        
            网页内容的最终解释权归本网站所有-本站已适配移动端 <br/>
        
        
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>

        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
